================================================================================
COGNITIV - IoT ENVIRONMENTAL MONITORING SYSTEM
Functionality and Technical Specifications Document
================================================================================

PROJECT OVERVIEW
================================================================================

Cognitiv is a comprehensive IoT system for monitoring environmental conditions
in indoor spaces, specifically designed to track:
- Temperature (Celsius)
- Humidity (percentage)
- Carbon Dioxide (CO2) levels (ppm - parts per million)

The system is built for ESP8266-based boards (ESP12-E, ESP12-S) and provides
real-time monitoring, historical data analysis, and intelligent insights through
an AI-powered assistant.

Status: Work in Progress

================================================================================
SYSTEM ARCHITECTURE
================================================================================

The system follows a three-tier architecture:

1. HARDWARE LAYER (Edge Devices)
   - ESP8266-based microcontrollers (ESP12-E, ESP12-S)
   - Environmental sensors (SHT40, SCD41)
   - I2C communication via LaskaKit μSup connectors
   - Optional display support (TFT displays for ESP32 variants)

2. BACKEND LAYER (Server)
   - Django REST API server
   - MongoDB database for time-series data storage
   - PlatformIO integration for firmware management
   - AI service integration (Google Gemini)

3. FRONTEND LAYER (Web Application)
   - React-based single-page application
   - Real-time dashboard with Chart.js visualizations
   - Historical data analysis interface
   - Device management and configuration interface
   - AI assistant chat interface

================================================================================
HARDWARE COMPONENTS
================================================================================

MICROCONTROLLER:
- Primary: ESP8266 (ESP12-E or ESP12-S modules)
- Alternative: ESP32 (for display-enabled variants)
- I2C Pins (ESP8266):
  * SDA: GPIO 4 (D2)
  * SCL: GPIO 5 (D1)
- I2C Pins (ESP32):
  * SDA: GPIO 21
  * SCL: GPIO 22

SENSORS:
- SHT40: Temperature and Humidity Sensor
  * Temperature range: -10°C to 50°C
  * Temperature accuracy: ±0.2°C
  * Humidity range: 0% to 100% RH
  * Humidity accuracy: ±2% RH
  * Interface: I2C

- SCD41: CO2, Temperature, and Humidity Sensor
  * CO2 range: 400-5000 ppm
  * CO2 accuracy: ±40 ppm
  * Temperature range: -10°C to 50°C
  * Temperature accuracy: ±0.5°C
  * Humidity range: 0% to 100% RH
  * Humidity accuracy: ±3% RH
  * Interface: I2C
  * Warm-up time: 60 seconds minimum

CONNECTIVITY:
- WiFi 802.11 b/g/n
- Operating range: ~50m indoors
- Auto-reconnection capability
- WiFi-on-demand mode (energy saving)

POWER MANAGEMENT:
- Deep sleep mode support (10-4260 seconds)
- Scheduled shutdown/wake functionality
- Power optimization for battery operation

================================================================================
SOFTWARE STACK
================================================================================

FIRMWARE:
- Platform: Arduino Framework
- Target: ESP8266 (espressif8266 platform)
- Board: ESP12E
- Libraries:
  * SparkFun SCD4x Arduino Library (v1.1.2+)
  * ArduinoJson (v6.21.3+)
  * Adafruit GFX Library (v1.11.10+)
  * Adafruit SSD1306 (v2.5.9+) - for display variants
  * ESP8266WiFi
  * ESP8266HTTPClient

BACKEND SERVER:
- Framework: Django 5.0.0+
- Language: Python 3.11+
- Database: MongoDB (via pymongo 4.7.0+)
- Web Server: Gunicorn 21.2.0+
- Static Files: WhiteNoise 6.6.0+
- CORS: django-cors-headers 4.3.0+
- AI Integration: google-generativeai
- Build Tool: PlatformIO (for firmware uploads)
- SSL/TLS: certifi 2024.2.2+

FRONTEND APPLICATION:
- Framework: React 18.2.0
- Build Tool: Vite 5.0.8
- Routing: React Router DOM 6.20.0
- HTTP Client: Axios 1.6.2
- Charts: Chart.js 4.4.0, react-chartjs-2 5.2.0
- Chart Plugins: chartjs-plugin-annotation 3.0.1

DEPLOYMENT:
- Platform: Render.com (configured via render.yaml)
- Environment: Python 3.11.0, Node.js 18
- Build Process: Automated frontend build + static collection

================================================================================
CORE FUNCTIONALITY
================================================================================

DATA COLLECTION:
- Automatic sensor readings at configurable intervals (default: 60 seconds)
- Dual sensor validation (SHT40 + SCD41 temperature/humidity comparison)
- Data validation with range checks:
  * Temperature: -10°C to 50°C
  * Humidity: 0% to 100%
  * CO2: 400 to 5000 ppm
- Timestamp synchronization via NTP
- Error handling and sensor health monitoring

DATA TRANSMISSION:
- HTTP POST requests to server endpoint
- JSON payload format
- Automatic retry on connection failure
- Request bundling option (multiple readings per request)
- WiFi-on-demand mode (connect only when transmitting)

DATA STORAGE:
- MongoDB time-series database
- Indexed by device_id and timestamp
- Raw payload preservation for debugging
- Automatic timezone conversion (UTC storage, local display)

DATA VISUALIZATION:
- Real-time dashboard with current readings
- Historical time-series charts (temperature, humidity, CO2)
- Statistical summaries (min, max, average)
- Air quality classification:
  * Good: < 1000 ppm CO2
  * Moderate: 1000-1500 ppm CO2
  * High: 1500-2000 ppm CO2
  * Critical: > 2000 ppm CO2
- Time range selection (hours, days, weeks, months)
- Data aggregation (hourly, daily, raw)
- CSV export functionality

DEVICE MANAGEMENT:
- Web-based device configuration interface
- WiFi credential management
- Firmware upload via PlatformIO
- Device naming and identification
- Multi-device support
- Device status monitoring (online/offline)
- Configuration options:
  * Request bundling enable/disable
  * WiFi-on-demand mode
  * Deep sleep configuration
  * Scheduled shutdown/wake times

ADMINISTRATION:
- Admin panel with authentication
- Device list and statistics
- Per-device detailed analytics
- System status monitoring
- Database health checks

AI ASSISTANT (MolekulAI):
- Natural language query interface
- Context-aware responses using recent sensor data
- Capabilities:
  * Application usage guidance
  * Data analysis and trend interpretation
  * Health recommendations based on CO2/temperature/humidity
  * Statistical insights
  * Anomaly detection assistance
- Powered by Google Gemini 2.5 Flash model
- Czech language interface

================================================================================
API ENDPOINTS
================================================================================

DATA ENDPOINTS:
- POST /api/data
  * Receives sensor data from devices
  * Validates and stores in MongoDB
  * Returns success/error status

- GET /api/data
  * Retrieves recent sensor data
  * Query parameters:
    - hours: Time range in hours (default: 24)
    - limit: Maximum records (default: 1000)
    - device_id: Filter by device (optional)
  * Returns JSON array of data points

- GET /api/stats
  * Statistical summary for time period
  * Query parameters:
    - hours: Time range (default: 24)
    - device_id: Filter by device (optional)
  * Returns min/max/avg for all metrics + CO2 quality breakdown

HISTORY ENDPOINTS:
- GET /api/history/series
  * Aggregated time series data
  * Query parameters:
    - start: ISO 8601 start datetime
    - end: ISO 8601 end datetime
    - bucket: 'hour', 'day', 'raw', or 'none' (default: 'day')
    - device_id: Filter by device (optional)
  * Returns aggregated series with min/max/avg per bucket

- GET /api/history/summary
  * Summary statistics for time range
  * Query parameters:
    - start: ISO 8601 start datetime
    - end: ISO 8601 end datetime
    - device_id: Filter by device (optional)
  * Returns comprehensive statistics including trends

- GET /api/history/export
  * CSV export of historical data
  * Query parameters:
    - start: ISO 8601 start datetime
    - end: ISO 8601 end datetime
    - device_id: Filter by device (optional)
  * Returns CSV file with UTF-8 BOM for Excel compatibility

DEVICE MANAGEMENT:
- POST /api/connect/upload
  * Configures device and uploads firmware
  * Request body:
    - boardName: Device identifier (required)
    - ssid: WiFi network name (required)
    - password: WiFi password
    - enableBundling: Boolean
    - enableWifiOnDemand: Boolean
    - enableDeepSleep: Boolean
    - deepSleepDurationSeconds: Integer (10-4260)
    - enableScheduledShutdown: Boolean
    - shutdownHour, shutdownMinute: Integer
    - wakeHour, wakeMinute: Integer
  * Returns upload status and log excerpt

ADMIN ENDPOINTS:
- POST /api/admin/login
  * Admin authentication
  * Request body: username, password
  * Returns session token

- GET /api/admin/devices
  * List all devices with summary statistics
  * Requires admin authentication
  * Returns device list with status and latest readings

- GET /api/admin/devices/<device_id>/stats
  * Detailed statistics for specific device
  * Requires admin authentication
  * Returns comprehensive device analytics

AI ENDPOINTS:
- POST /api/ai/chat
  * AI assistant query interface
  * Request body:
    - message: User query (required)
    - device_id: Optional device filter
  * Returns AI response with data context

SYSTEM ENDPOINTS:
- GET /api/status
  * Server health check
  * Returns database status, data point count, latest entry timestamp

- GET /api/debug/build-info
  * Debug endpoint for React build directory location
  * Returns build path information

================================================================================
DATA FORMATS
================================================================================

DEVICE TO SERVER (POST /api/data):
{
  "timestamp": 1699012345,          // Unix timestamp
  "device_id": "livingroom_01",   // Device identifier
  "temp_sht40": 22.50,             // SHT40 temperature
  "humidity_sht40": 45.20,         // SHT40 humidity
  "temp_scd41": 22.30,             // SCD41 temperature
  "humidity_scd41": 44.80,         // SCD41 humidity
  "co2": 650                        // CO2 in ppm
}

SERVER STORAGE (MongoDB Document):
{
  "_id": ObjectId("..."),
  "timestamp": ISODate("2024-11-03T10:30:00Z"),  // UTC datetime
  "timestamp_str": "2024-11-03 10:30:00",        // Local time string
  "device_id": "livingroom_01",
  "temperature": 22.5,              // Normalized (average of sensors)
  "humidity": 45.2,                 // Normalized
  "co2": 650,
  "raw_payload": { ... }            // Original device payload
}

SERVER TO FRONTEND (GET /api/data):
{
  "status": "success",
  "count": 360,
  "data": [
    {
      "timestamp": "2024-11-03 10:30:00",
      "timestamp_iso": "2024-11-03T10:30:00+01:00",
      "device_id": "livingroom_01",
      "temperature": 22.50,
      "humidity": 45.20,
      "co2": 650,
      "temp_avg": 22.50,
      "humidity_avg": 45.20
    }
  ]
}

STATISTICS RESPONSE (GET /api/stats):
{
  "status": "success",
  "stats": {
    "temperature": {
      "min": 20.1,
      "max": 24.5,
      "avg": 22.3,
      "current": 22.5
    },
    "humidity": {
      "min": 40.0,
      "max": 55.0,
      "avg": 47.5,
      "current": 45.2
    },
    "co2": {
      "min": 420,
      "max": 850,
      "avg": 625,
      "current": 650
    },
    "data_points": 360,
    "time_range_hours": 24,
    "co2_quality": {
      "good": 320,
      "moderate": 35,
      "high": 5,
      "critical": 0,
      "good_percent": 88.9,
      "moderate_percent": 9.7,
      "high_percent": 1.4,
      "critical_percent": 0.0
    }
  }
}

================================================================================
CONFIGURATION OPTIONS
================================================================================

FIRMWARE CONFIGURATION (config.h):
- WIFI_SSID: WiFi network name
- WIFI_PASSWORD: WiFi password
- SERVER_URL: Backend API endpoint URL
- DEVICE_ID: Unique device identifier
- READING_INTERVAL: Sensor reading interval in milliseconds
- ENABLE_BUNDLING: Enable request bundling (0/1)
- ENABLE_WIFI_ON_DEMAND: WiFi-on-demand mode (0/1)
- ENABLE_DEEP_SLEEP: Deep sleep mode (0/1)
- DEEP_SLEEP_DURATION_US: Deep sleep duration in microseconds
- ENABLE_SCHEDULED_SHUTDOWN: Scheduled shutdown (0/1)
- SHUTDOWN_HOUR, SHUTDOWN_MINUTE: Shutdown time
- WAKE_HOUR, WAKE_MINUTE: Wake time

SERVER CONFIGURATION (Environment Variables):
- DJANGO_SECRET_KEY: Django secret key
- DEBUG: Debug mode (true/false)
- MONGO_URI: MongoDB connection string
- MONGO_DB_NAME: Database name (default: cognitiv)
- MONGO_COLLECTION: Collection name (default: sensor_data)
- LOCAL_TIMEZONE: Timezone for display (default: Europe/Prague)
- GEMINI_API_KEY: Google Gemini API key for AI assistant
- GEMINI_MODEL: Gemini model name (default: gemini-2.5-flash)

FRONTEND CONFIGURATION:
- API base URL: Configured in services/api.js
- Chart refresh interval: 30 seconds (configurable)
- Default time range: 24 hours (configurable)

================================================================================
DEPLOYMENT ARCHITECTURE
================================================================================

BUILD PROCESS:
1. Frontend build: npm install && npm run build
2. Backend dependencies: pip install -r requirements.txt
3. Static file collection: python manage.py collectstatic
4. Server start: gunicorn cognitiv.wsgi:application

DEPLOYMENT PLATFORM (Render.com):
- Service type: Web service
- Environment: Python 3.11.0, Node.js 18
- Build command: Automated frontend build + static collection
- Start command: Gunicorn WSGI server
- Environment variables: Configured via Render dashboard

DATABASE:
- MongoDB Atlas (cloud-hosted)
- Connection: TLS/SSL with certificate validation
- Indexes: device_id + timestamp (compound index)
- Timezone: UTC storage, local timezone conversion for display

STATIC FILES:
- React build served via WhiteNoise middleware
- Automatic asset path resolution
- Cache headers for production optimization
- Fallback to static HTML if React build unavailable

================================================================================
SECURITY FEATURES
================================================================================

AUTHENTICATION:
- Admin panel: Session-based authentication
- API endpoints: CSRF protection (exempted where needed)
- Signed cookie sessions (24-hour expiration)

DATA VALIDATION:
- Input validation on all API endpoints
- Range checks for sensor data
- Type validation for all parameters
- SQL injection prevention (MongoDB parameterized queries)

NETWORK SECURITY:
- CORS configuration (configurable for production)
- HTTPS support (via Render.com)
- Secure cookie settings (HttpOnly, SameSite)

CONFIGURATION SECURITY:
- Credentials stored in environment variables
- Config.h file excluded from version control
- API keys not exposed in client-side code

================================================================================
PERFORMANCE CHARACTERISTICS
================================================================================

FIRMWARE:
- Reading interval: 60 seconds (configurable)
- Sensor warm-up: 60 seconds (SCD41)
- WiFi connection: ~5-10 seconds
- Data transmission: < 1 second per request
- Deep sleep power consumption: < 10μA

SERVER:
- Request handling: < 100ms average
- Database queries: Optimized with indexes
- Concurrent devices: 100+ supported
- Data aggregation: Efficient MongoDB pipelines
- Static file serving: WhiteNoise optimized

FRONTEND:
- Initial load: < 2 seconds
- Chart rendering: < 500ms
- Auto-refresh: 30-second intervals
- Chart data points: Auto-sampled for >100 points

DATABASE:
- Storage: Time-series optimized
- Query performance: Indexed lookups
- Scalability: Millions of records supported
- Aggregation: Efficient pipeline operations

================================================================================
EXTENSIBILITY AND FUTURE ENHANCEMENTS
================================================================================

PLANNED FEATURES (Active Development):
- Deep sleep configuration improvements
- Energy-efficient transmission optimization
- HTTP request bundling enhancements
- Scheduled shutdown/wake functionality

POTENTIAL ENHANCEMENTS:
- Additional sensors (PM2.5, TVOC, light)
- MQTT protocol support
- Home Assistant integration
- Mobile app (React Native)
- Email/SMS alerts
- Machine learning predictions
- Multi-user accounts
- Advanced analytics dashboard
- Weather correlation
- Occupancy detection algorithms
- HVAC control integration

================================================================================
DEVELOPMENT WORKFLOW
================================================================================

SPEC-DRIVEN DEVELOPMENT (SDD):
The project follows a spec-driven development methodology:
- /brief: 30-minute planning for new features
- /evolve: Living documentation updates
- /research: Comprehensive research phase
- /specify: Detailed specification creation
- /plan: Implementation planning
- /tasks: Task breakdown
- /implement: Code implementation

DOCUMENTATION:
- Active specs: specs/active/[task-id]/
- Roadmaps: specs/todo-roadmap/
- Templates: .sdd/templates/
- Guidelines: .sdd/guidelines.md

================================================================================
TROUBLESHOOTING AND SUPPORT
================================================================================

COMMON ISSUES:
- WiFi connection failures: Check credentials, signal strength
- Sensor initialization errors: Verify I2C connections, power supply
- Data transmission failures: Check server URL, network connectivity
- Database connection errors: Verify MONGO_URI, network access

DEBUGGING:
- Serial monitor: 115200 baud for firmware debugging
- Server logs: Django logging for backend issues
- Browser console: React DevTools for frontend debugging
- Database queries: MongoDB Compass for data inspection

DOCUMENTATION:
- Quick Start Guide: docs/QUICKSTART.md
- Troubleshooting Guide: docs/TROUBLESHOOTING.md
- Project Guide: PROJECT_GUIDE.md
- PlatformIO Guide: PLATFORMIO_GUIDE.md

================================================================================
LICENSE AND ATTRIBUTION
================================================================================

Status: Work in Progress
Development Framework: Spec-Driven Development (SDD)
Primary Language: Czech (user interface), English (code/documentation)

================================================================================
END OF DOCUMENT
================================================================================




