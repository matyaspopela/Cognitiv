<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognitiv • Přehled prostředí</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
    <style>
        :root {
            --bg: #eef2ff;
            --surface: #ffffff;
            --surface-elevated: rgba(255, 255, 255, 0.9);
            --outline: rgba(15, 23, 42, 0.08);
            --shadow: 0 28px 48px rgba(15, 23, 42, 0.12);
            --shadow-soft: 0 18px 36px rgba(15, 23, 42, 0.08);
            --text: #0f172a;
            --muted: #64748b;
            --accent: #2563eb;
            --accent-strong: #9333ea;
            --success: #16a34a;
            --warning: #f97316;
            --danger: #dc2626;
            --page-padding: clamp(20px, 4vw, 40px);
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(160deg, #eef2ff 0%, #f8fafc 50%, #e0f2fe 100%);
            color: var(--text);
            min-height: 100vh;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        .page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: var(--page-padding);
            gap: clamp(28px, 4vw, 44px);
        }

        header {
            background: var(--surface);
            border-radius: clamp(20px, 3vw, 32px);
            padding: clamp(24px, 3vw, 36px);
            border: 1px solid var(--outline);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: clamp(18px, 2vw, 28px);
        }

        .header-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: clamp(12px, 2vw, 24px);
        }

        .brand {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: clamp(20px, 2.5vw, 26px);
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: var(--text);
        }

        .nav-links {
            display: inline-flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 999px;
            padding: 6px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.4);
        }

        .nav-links a {
            font-size: 14px;
            font-weight: 500;
            padding: 10px 18px;
            border-radius: 999px;
            color: var(--muted);
            transition: background 0.25s ease, color 0.25s ease, transform 0.25s ease;
        }

        .nav-links a:hover,
        .nav-links a.active {
            background: rgba(37, 99, 235, 0.12);
            color: var(--accent);
            transform: translateY(-2px);
        }

        .status-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
        }

        .header-bar .status-group {
            align-items: flex-end;
            text-align: right;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.16);
            font-size: 14px;
            font-weight: 500;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.online {
            background: var(--success);
        }

        .status-dot.offline {
            background: var(--danger);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .last-update {
            font-size: 13px;
            color: var(--muted);
        }

        .header-body {
            display: flex;
            flex-wrap: wrap;
            gap: clamp(20px, 2.5vw, 28px);
            align-items: flex-end;
            justify-content: space-between;
        }

        .header-copy {
            max-width: clamp(420px, 46vw, 560px);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .header-copy h1 {
            margin: 0;
            font-size: clamp(28px, 4vw, 38px);
            letter-spacing: -0.01em;
        }

        .header-copy .subtitle {
            margin: 0;
            color: var(--muted);
            font-size: 15px;
        }

        .animated-block {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.6s ease, transform 0.6s ease, box-shadow 0.4s ease;
        }

        .page.loading .animated-block {
            opacity: 0;
            transform: translateY(16px);
        }

        .page.loaded .animated-block {
            opacity: 1;
            transform: translateY(0);
        }

        .metrics-grid.animated-block {
            transition-delay: 0.05s;
        }

        .quality-card.animated-block {
            transition-delay: 0.1s;
        }

        .trend-analysis.animated-block {
            transition-delay: 0.15s;
        }

        .charts-section.animated-block {
            transition-delay: 0.2s;
        }

        .header-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
        }

        .controls-left {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }

        .control-label {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--muted);
        }

        select {
            padding: 12px 16px;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(248, 250, 252, 0.85);
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            min-width: 180px;
            outline: none;
            box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.05);
        }

        button {
            padding: 12px 20px;
            border-radius: 14px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
            color: #fff;
            box-shadow: 0 16px 32px rgba(37, 99, 235, 0.35);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .content {
            margin-top: clamp(28px, 4vw, 48px);
            display: flex;
            flex-direction: column;
            gap: clamp(28px, 4vw, 48px);
        }

        .alert {
            border-radius: 18px;
            padding: 14px 18px;
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
            border: 1px solid rgba(220, 38, 38, 0.2);
            font-weight: 500;
        }

        .metrics-grid {
            display: grid;
            gap: clamp(18px, 2.5vw, 24px);
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .metric-card {
            background: var(--surface);
            border-radius: 22px;
            padding: clamp(20px, 2.2vw, 26px);
            border: 1px solid var(--outline);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: 16px;
            transition: transform 0.4s ease, box-shadow 0.4s ease, background 0.4s ease;
        }

        .page.loaded .metric-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 24px 48px rgba(15, 23, 42, 0.16);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--muted);
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .metric-value {
            font-size: clamp(30px, 3.4vw, 36px);
            font-weight: 700;
            display: flex;
            align-items: baseline;
            gap: 6px;
            transition: color 0.35s ease;
        }

        .metric-value.value-updated {
            animation: valuePop 0.6s ease;
        }

        @keyframes valuePop {
            0% {
                transform: scale(1);
            }
            35% {
                transform: scale(1.06);
            }
            65% {
                transform: scale(0.97);
            }
            100% {
                transform: scale(1);
            }
        }

        .metric-value.temp {
            color: #f97316;
        }

        .metric-value.humidity {
            color: #0ea5e9;
        }

        .metric-value.co2 {
            color: #14b8a6;
        }

        .metric-value.co2.caution {
            color: #facc15;
        }

        .metric-value.co2.warning {
            color: var(--warning);
        }

        .metric-value.co2.danger {
            color: var(--danger);
        }

        .metric-unit {
            font-size: 16px;
            font-weight: 500;
            color: var(--muted);
        }

        .metric-breakdown {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 13px;
            color: var(--muted);
        }

        .metric-breakdown span {
            display: inline-flex;
            gap: 6px;
            align-items: center;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.06);
            font-size: 12px;
            color: var(--muted);
        }

        .quality-card {
            background: var(--surface);
            border-radius: 24px;
            padding: clamp(24px, 3vw, 30px);
            border: 1px solid var(--outline);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .quality-header {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 12px;
        }

        .quality-header h2 {
            margin: 0;
            font-size: clamp(20px, 2.6vw, 26px);
        }

        .quality-header p {
            margin: 0;
            color: var(--muted);
            font-size: 14px;
        }

        .quality-bars {
            display: grid;
            gap: 14px;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        }

        .trend-analysis {
            background: var(--surface);
            border-radius: clamp(20px, 3vw, 28px);
            padding: clamp(24px, 3vw, 32px);
            border: 1px solid var(--outline);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: clamp(20px, 2vw, 28px);
        }

        .trend-analysis header {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .trend-analysis header h2 {
            margin: 0;
            font-size: clamp(20px, 3vw, 26px);
        }

        .trend-analysis header p {
            margin: 0;
            color: var(--muted);
            font-size: 14px;
        }

        .trend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: clamp(18px, 2.5vw, 24px);
        }

        .trend-card {
            border-radius: 20px;
            padding: clamp(18px, 2.4vw, 24px);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(147, 51, 234, 0.06));
            border: 1px solid rgba(148, 163, 184, 0.28);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.18);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .trend-card h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .trend-direction {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .trend-direction.raising {
            color: #16a34a;
        }

        .trend-direction.falling {
            color: #dc2626;
        }

        .trend-direction.steady {
            color: var(--muted);
        }

        .trend-detail {
            font-size: 13px;
            color: var(--muted);
            line-height: 1.5;
        }

        .quality-bar {
            border-radius: 18px;
            padding: 18px 20px;
            color: #fff;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: transform 0.4s ease, box-shadow 0.4s ease;
        }

        .page.loaded .quality-bar:hover {
            transform: translateY(-4px);
            box-shadow: 0 18px 34px rgba(15, 23, 42, 0.18);
        }

        .quality-bar.good {
            background: linear-gradient(135deg, rgba(22, 163, 74, 0.85), rgba(34, 197, 94, 0.9));
        }

        .quality-bar.moderate {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.9), rgba(250, 204, 21, 0.9));
        }

        .quality-bar.high {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.9), rgba(234, 88, 12, 0.9));
        }

        .quality-bar.critical {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.9), rgba(239, 68, 68, 0.85));
        }

        .quality-bar strong {
            font-size: 24px;
        }

        .quality-bar span {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .charts-section {
            background: var(--surface);
            border-radius: clamp(24px, 3vw, 36px);
            padding: clamp(24px, 3vw, 36px);
            border: 1px solid var(--outline);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: clamp(20px, 3vw, 28px);
        }

        .charts-header {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .charts-header h2 {
            margin: 0;
            font-size: clamp(22px, 3vw, 28px);
        }

        .charts-header p {
            margin: 0;
            color: var(--muted);
            font-size: 14px;
            max-width: 560px;
        }

        .chart-stack-wrapper {
            position: relative;
        }

        .chart-stack {
            display: flex;
            flex-direction: column;
            gap: clamp(28px, 3vw, 40px);
        }

        .chart-panel {
            background: var(--surface-elevated);
            border-radius: 24px;
            border: 1px solid var(--outline);
            padding: clamp(24px, 3vw, 32px);
            display: flex;
            flex-direction: column;
            gap: 18px;
            box-shadow: var(--shadow-soft);
            min-height: clamp(420px, 70vh, 560px);
        }

        .chart-panel h3 {
            margin: 0;
            font-size: clamp(18px, 2.6vw, 22px);
        }

        .chart-panel p {
            margin: 0;
            color: var(--muted);
            font-size: 14px;
        }

        .chart-canvas {
            position: relative;
            flex: 1;
            min-height: clamp(340px, 60vh, 520px);
        }

        .chart-canvas canvas {
            width: 100%;
            height: 100%;
        }

        footer {
            margin-top: clamp(40px, 5vw, 60px);
            text-align: center;
            color: var(--muted);
            font-size: 13px;
            padding-bottom: 20px;
        }

        @media (max-width: 640px) {
            .header-controls {
                align-items: stretch;
            }

            select, button {
                width: 100%;
            }
        }
    </style>
</head>
    <body>
        <div class="page loading">
        <header>
            <div class="header-bar">
                <nav>
                    <a class="brand" href="/">Cognitiv</a>
                    <div class="nav-links">
                        <a href="/">Domů</a>
                        <a href="/connect">Připojit</a>
                        <a href="/dashboard" class="active">Přehled</a>
                        <a href="/history">Historie</a>
                    </div>
                </nav>
                <div class="status-group">
                    <div class="status-indicator">
                        <span class="status-dot online" id="serverStatus"></span>
                        <span id="serverStatusText">Server online</span>
                    </div>
                    <div class="last-update" id="lastUpdate">Poslední aktualizace: nikdy</div>
                </div>
            </div>
            <div class="header-body">
                <div class="header-copy">
                    <h1>Dashboard pro monitorování prostředí</h1>
                    <p class="subtitle">Podrobný pohled na komfort a kvalitu vzduchu z vašich senzorů Cognitiv.</p>
                </div>
                <div class="header-controls">
                    <div class="controls-left">
                        <label class="control-label" for="timeRange">
                            Časové období
                            <select id="timeRange">
                                <option value="1">Poslední 1 hodina</option>
                                <option value="6">Posledních 6 hodin</option>
                                <option value="24" selected>Posledních 24 hodin</option>
                                <option value="168">Posledních 7 dní</option>
                                <option value="720">Posledních 30 dní</option>
                            </select>
                        </label>
                    </div>
                    <button class="btn-primary" id="refreshButton" onclick="refreshData()">⟳ Aktualizovat data</button>
                </div>
            </div>
        </header>

        <main class="content">
            <div id="errorContainer"></div>

            <section class="metrics-grid animated-block">
                <article class="metric-card">
                    <div class="metric-header">
                        <span>Teplota</span>
                    </div>
                    <div class="metric-value temp" id="currentTemp">
                        --<span class="metric-unit">°C</span>
                    </div>
                    <div class="metric-breakdown">
                        <span>Min <strong id="minTemp">--</strong></span>
                        <span>Max <strong id="maxTemp">--</strong></span>
                        <span>Průměr <strong id="avgTemp">--</strong></span>
                    </div>
                </article>

                <article class="metric-card">
                    <div class="metric-header">
                        <span>Vlhkost</span>
                    </div>
                    <div class="metric-value humidity" id="currentHumidity">
                        --<span class="metric-unit">%</span>
                    </div>
                    <div class="metric-breakdown">
                        <span>Min <strong id="minHumidity">--</strong></span>
                        <span>Max <strong id="maxHumidity">--</strong></span>
                        <span>Průměr <strong id="avgHumidity">--</strong></span>
                    </div>
                </article>

                <article class="metric-card">
                    <div class="metric-header">
                        <span>CO₂</span>
                    </div>
                    <div class="metric-value co2" id="currentCO2">
                        --<span class="metric-unit">ppm</span>
                    </div>
                    <div class="metric-breakdown">
                        <span>Min <strong id="minCO2">--</strong></span>
                        <span>Max <strong id="maxCO2">--</strong></span>
                        <span>Průměr <strong id="avgCO2">--</strong></span>
                    </div>
                </article>

                <article class="metric-card">
                    <div class="metric-header">
                        <span>Datové pokrytí</span>

                    </div>
                    <div class="metric-value" style="color: var(--accent);" id="dataPoints">
                        --
                    </div>
                    <div class="metric-breakdown">
                        <span>Záznamů v okně</span>
                    </div>
                </article>
            </section>

            <section class="quality-card animated-block">
                <div class="quality-header">
                    <h2>Rozložení kvality vzduchu</h2>
                    <p>Podíl měření v jednotlivých pásmech CO₂ pro zvolené období.</p>
                </div>
                <div class="quality-bars">
                    <div class="quality-bar good">
                        <span>Dobrá</span>
                        <strong id="co2Good">--%</strong>
                        <small>&lt; 1000 ppm</small>
                    </div>
                    <div class="quality-bar moderate">
                        <span>Střední</span>
                        <strong id="co2Moderate">--%</strong>
                        <small>1000 – 1499 ppm</small>
                    </div>
                    <div class="quality-bar high">
                        <span>Špatná</span>
                        <strong id="co2High">--%</strong>
                        <small>1500 – 1999 ppm</small>
                    </div>
                    <div class="quality-bar critical">
                        <span>Kritická</span>
                        <strong id="co2Critical">--%</strong>
                        <small>&ge; 2000 ppm</small>
                    </div>
                </div>
            </section>

            <section class="trend-analysis animated-block">
                <header>
                    <h2>Trendy</h2>
                    <p>Porovnáváme první a poslední měření v zadaném období a zvýrazňujeme, zda podmínky rostou, klesají nebo zůstávají stabilní.</p>
                </header>
                <div class="trend-grid">
                    <article class="trend-card">
                        <h3>Teplota</h3>
                        <div class="trend-direction steady" id="tempTrendDirection">--</div>
                        <div class="trend-detail" id="tempTrendDetail">Čekám na data…</div>
                    </article>
                    <article class="trend-card">
                        <h3>Vlhkost</h3>
                        <div class="trend-direction steady" id="humidityTrendDirection">--</div>
                        <div class="trend-detail" id="humidityTrendDetail">Čekám na data…</div>
                    </article>
                    <article class="trend-card">
                        <h3>CO₂</h3>
                        <div class="trend-direction steady" id="co2TrendDirection">--</div>
                        <div class="trend-detail" id="co2TrendDetail">Čekám na data…</div>
                    </article>
                </div>
            </section>

            <section class="charts-section animated-block">
                <div class="charts-header">
                    <h2>Grafy z časového úseku</h2>
                    <p>Přehledné porovnání hodnot teploty, vlhkosti a koncentrace CO₂ v čase.</p>
                </div>
                <div class="chart-stack-wrapper">
                    <div class="chart-stack" id="chartStack">
                        <article class="chart-panel" data-chart="temperature">
                            <div>
                                <h3>Teplota v čase</h3>
                                <p>Sledujte změny mikroklimatu a rychle odhalte epizody vytápění či ochlazení.</p>
                            </div>
                            <div class="chart-canvas">
                                <canvas id="tempChart"></canvas>
                            </div>
                        </article>
                        <article class="chart-panel" data-chart="humidity">
                            <div>
                                <h3>Vlhkost v čase</h3>
                                <p>Kontrolujte, že se vlhkost drží ve zdravém pásmu pro pohodlí i techniku.</p>
                            </div>
                            <div class="chart-canvas">
                                <canvas id="humidityChart"></canvas>
                            </div>
                        </article>
                        <article class="chart-panel" data-chart="co2">
                            <div>
                                <h3>CO₂ v čase</h3>
                                <p>Odhalte nedostatečné větrání pomocí prahů pro jednotlivá pásma kvality vzduchu.</p>
                            </div>
                            <div class="chart-canvas">
                                <canvas id="co2Chart"></canvas>
                            </div>
                        </article>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            Navrženo pro klidné a přehledné sledování. <a href="/">Zpět na domov</a>
        </footer>
    </div>

    <script>
        let tempChart, humidityChart, co2Chart;
        let autoRefreshInterval;
        let pageEl;
        let hasLoadedData = false;

        const dateTimeFormatter = new Intl.DateTimeFormat('cs-CZ', {
            dateStyle: 'medium',
            timeStyle: 'medium'
        });

        const timeFormatter = new Intl.DateTimeFormat('cs-CZ', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });

        function parseTimestamp(point) {
            if (!point) {
                return null;
            }

            if (point.timestamp_iso) {
                const isoDate = new Date(point.timestamp_iso);
                if (!Number.isNaN(isoDate.getTime())) {
                    return isoDate;
                }
            }

            if (point.timestamp) {
                const normalized = point.timestamp.replace(' ', 'T');
                const fallbackDate = new Date(normalized);
                if (!Number.isNaN(fallbackDate.getTime())) {
                    return fallbackDate;
                }
            }

            return null;
        }

        function formatTimestampDisplay(isoValue, fallback) {
            const date = parseTimestamp({ timestamp_iso: isoValue, timestamp: fallback });
            if (date) {
                return dateTimeFormatter.format(date);
            }
            if (fallback) {
                return fallback;
            }
            return 'Neznámý čas';
        }

        function animateValue(element) {
            if (!element) {
                return;
            }
            element.classList.remove('value-updated');
            void element.offsetWidth;
            element.classList.add('value-updated');
        }

        function safeValue(value) {
            return value === undefined || value === null || Number.isNaN(value) ? '--' : value;
        }

        function initCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#e2e8f0',
                        padding: 12,
                        displayColors: false,
                        borderWidth: 1,
                        borderColor: 'rgba(148, 163, 184, 0.3)'
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(148, 163, 184, 0.15)'
                        },
                        ticks: {
                            color: 'rgba(100, 116, 139, 0.9)',
                            maxRotation: 0,
                            autoSkipPadding: 16
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(148, 163, 184, 0.15)'
                        },
                        ticks: {
                            color: 'rgba(100, 116, 139, 0.9)'
                        }
                    }
                }
            };

            const tempCtx = document.getElementById('tempChart').getContext('2d');
            tempChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Teplota (°C)',
                        data: [],
                        borderColor: '#fb923c',
                        backgroundColor: 'rgba(251, 146, 60, 0.12)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.35
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            title: {
                                display: true,
                                text: '°C'
                            }
                        }
                    }
                }
            });

            const humidityCtx = document.getElementById('humidityChart').getContext('2d');
            humidityChart = new Chart(humidityCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Vlhkost (%)',
                        data: [],
                        borderColor: '#38bdf8',
                        backgroundColor: 'rgba(56, 189, 248, 0.12)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.35
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            title: {
                                display: true,
                                text: '%'
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    }
                }
            });

            const co2Ctx = document.getElementById('co2Chart').getContext('2d');
            co2Chart = new Chart(co2Ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CO₂ (ppm)',
                        data: [],
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.12)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.35
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            title: {
                                display: true,
                                text: 'ppm'
                            }
                        }
                    },
                    plugins: {
                        ...commonOptions.plugins,
                        annotation: {
                            annotations: {
                                good: {
                                    type: 'line',
                                    yMin: 1000,
                                    yMax: 1000,
                                    borderColor: '#facc15',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        enabled: true,
                                        content: 'Prahová hodnota 1000 ppm',
                                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                        color: '#fff',
                                        position: 'start'
                                    }
                                },
                                high: {
                                    type: 'line',
                                    yMin: 1500,
                                    yMax: 1500,
                                    borderColor: '#f97316',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        enabled: true,
                                        content: 'Prahová hodnota 1500 ppm',
                                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                        color: '#fff',
                                        position: 'start'
                                    }
                                },
                                critical: {
                                    type: 'line',
                                    yMin: 2000,
                                    yMax: 2000,
                                    borderColor: '#dc2626',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        enabled: true,
                                        content: 'Prahová hodnota 2000 ppm',
                                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                        color: '#fff',
                                        position: 'start'
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        async function fetchData() {
            try {
                const hours = document.getElementById('timeRange').value;

                const dataResponse = await fetch(`/data?hours=${hours}`);
                let dataJson;
                try {
                    dataJson = await dataResponse.json();
                } catch (e) {
                    console.error('Chyba parsování /data:', e);
                    throw new Error(`Nepodařilo se parsovat odpověď z /data: ${e.message}`);
                }
                
                console.log('Data response:', { status: dataResponse.status, ok: dataResponse.ok, json: dataJson });
                
                if (!dataResponse.ok) {
                    const errorMsg = dataJson?.error || dataJson?.message || `HTTP ${dataResponse.status}: Chyba při načítání dat`;
                    throw new Error(errorMsg);
                }
                // Only check status if it exists and is not success
                if (dataJson.status && dataJson.status !== 'success') {
                    const errorMsg = dataJson.error || dataJson.message || 'Chyba při načítání dat';
                    throw new Error(errorMsg);
                }

                const statsResponse = await fetch(`/stats?hours=${hours}`);
                let statsJson;
                try {
                    statsJson = await statsResponse.json();
                } catch (e) {
                    console.error('Chyba parsování /stats:', e);
                    throw new Error(`Nepodařilo se parsovat odpověď z /stats: ${e.message}`);
                }
                
                console.log('Stats response:', { status: statsResponse.status, ok: statsResponse.ok, json: statsJson });
                
                if (!statsResponse.ok) {
                    const errorMsg = statsJson?.error || statsJson?.message || `HTTP ${statsResponse.status}: Chyba při načítání statistik`;
                    throw new Error(errorMsg);
                }
                // Only check status if it exists and is not success
                if (statsJson.status && statsJson.status !== 'success') {
                    const errorMsg = statsJson.error || statsJson.message || 'Chyba při načítání statistik';
                    throw new Error(errorMsg);
                }

                // Both responses are successful - data might be empty, that's OK
                updateUI(dataJson.data || [], statsJson.stats || {});
                updateServerStatus(true);
            } catch (error) {
                console.error('Chyba při načítání dat:', error);
                updateServerStatus(false);
                showError(`Nepodařilo se spojit se serverem: ${error.message || 'Zkontrolujte, zda server běží.'}`);
                // Exit loading state even on error and show empty state
                if (pageEl && !hasLoadedData) {
                    pageEl.classList.remove('loading');
                    pageEl.classList.add('loaded');
                    hasLoadedData = true;
                }
                // Still try to update UI with empty data so page structure is visible
                updateUI([], {});
            }
        }

        function updateUI(data, stats) {
            // Exit loading state regardless of data availability
            if (pageEl && !hasLoadedData) {
                pageEl.classList.remove('loading');
                pageEl.classList.add('loaded');
                hasLoadedData = true;
            }

            // Normalize inputs
            data = data || [];
            stats = stats || {};

            if (data.length === 0 || Object.keys(stats).length === 0) {
                showError('V tomto úseku nejsou žádná data.');
                // Still update UI elements with default/empty values so structure is visible
                document.getElementById('currentTemp').innerHTML = '—<span class="metric-unit">°C</span>';
                document.getElementById('currentHumidity').innerHTML = '—<span class="metric-unit">%</span>';
                document.getElementById('currentCO2').innerHTML = '—<span class="metric-unit">ppm</span>';
                const dataPointsElement = document.getElementById('dataPoints');
                if (dataPointsElement) {
                    dataPointsElement.textContent = '—';
                }
                // Reset CO₂ quality distribution to 0 % so previous values are not shown
                const qualityDefaults = {
                    co2Good: '0%',
                    co2Moderate: '0%',
                    co2High: '0%',
                    co2Critical: '0%',
                };
                Object.entries(qualityDefaults).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = value;
                    }
                });
                return;
            }

            clearError();

            const temperatureStats = stats.temperature ?? {};
            const humidityStats = stats.humidity ?? {};
            const co2Stats = stats.co2 ?? {};

            const tempElement = document.getElementById('currentTemp');
            const tempCurrent = safeValue(temperatureStats.current);
            tempElement.innerHTML = `${tempCurrent}<span class="metric-unit">°C</span>`;
            animateValue(tempElement);

            const humidityElement = document.getElementById('currentHumidity');
            const humidityCurrent = safeValue(humidityStats.current);
            humidityElement.innerHTML = `${humidityCurrent}<span class="metric-unit">%</span>`;
            animateValue(humidityElement);

            const co2Element = document.getElementById('currentCO2');
            const co2CurrentRaw = co2Stats.current;
            const co2Current = safeValue(co2CurrentRaw);
            co2Element.innerHTML = `${co2Current}<span class="metric-unit">ppm</span>`;
            co2Element.className = 'metric-value co2';
            if (typeof co2CurrentRaw === 'number') {
                if (co2CurrentRaw >= 2000) {
                    co2Element.classList.add('danger');
                } else if (co2CurrentRaw >= 1500) {
                    co2Element.classList.add('warning');
                } else if (co2CurrentRaw >= 1000) {
                    co2Element.classList.add('caution');
                }
            }
            animateValue(co2Element);

            document.getElementById('minTemp').textContent = safeValue(temperatureStats.min);
            document.getElementById('maxTemp').textContent = safeValue(temperatureStats.max);
            document.getElementById('avgTemp').textContent = safeValue(temperatureStats.avg);

            document.getElementById('minHumidity').textContent = safeValue(humidityStats.min);
            document.getElementById('maxHumidity').textContent = safeValue(humidityStats.max);
            document.getElementById('avgHumidity').textContent = safeValue(humidityStats.avg);

            document.getElementById('minCO2').textContent = safeValue(co2Stats.min);
            document.getElementById('maxCO2').textContent = safeValue(co2Stats.max);
            document.getElementById('avgCO2').textContent = safeValue(co2Stats.avg);

            const dataPointsElement = document.getElementById('dataPoints');
            dataPointsElement.textContent = safeValue(stats.data_points);
            animateValue(dataPointsElement);

            const quality = stats.co2_quality || { good_percent: 0, moderate_percent: 0, high_percent: 0, critical_percent: 0 };
            document.getElementById('co2Good').textContent = `${quality.good_percent ?? 0}%`;
            document.getElementById('co2Moderate').textContent = `${quality.moderate_percent ?? 0}%`;
            document.getElementById('co2High').textContent = `${quality.high_percent ?? 0}%`;
            document.getElementById('co2Critical').textContent = `${quality.critical_percent ?? 0}%`;

            updateCharts(data);
            updateTrendInsights(data);

            const lastData = data[data.length - 1];
            document.getElementById('lastUpdate').textContent =
                `Poslední aktualizace: ${formatTimestampDisplay(lastData.timestamp_iso, lastData.timestamp)}`;
        }

        function updateCharts(data) {
            let sampledData = data;
            if (data.length > 200) {
                const step = Math.ceil(data.length / 200);
                sampledData = data.filter((_, index) => index % step === 0);
            }

            const labels = sampledData.map((point) => {
                const date = parseTimestamp(point);
                if (!date) {
                    return point.timestamp ?? '';
                }
                return timeFormatter.format(date);
            });

            tempChart.data.labels = labels;
            tempChart.data.datasets[0].data = sampledData.map((point) => point.temp_avg ?? point.temperature);
            tempChart.update();

            humidityChart.data.labels = labels;
            humidityChart.data.datasets[0].data = sampledData.map((point) => point.humidity_avg ?? point.humidity);
            humidityChart.update();

            co2Chart.data.labels = labels;
            co2Chart.data.datasets[0].data = sampledData.map((point) => point.co2);
            co2Chart.update();
        }

        function updateTrendInsights(data) {
            const trendConfigs = [
                {
                    keys: ['temp_avg', 'temperature'],
                    directionEl: 'tempTrendDirection',
                    detailEl: 'tempTrendDetail',
                    unit: '°C',
                    threshold: 0.4,
                    format: (value) => `${value.toFixed(1)}°C`
                },
                {
                    keys: ['humidity_avg', 'humidity'],
                    directionEl: 'humidityTrendDirection',
                    detailEl: 'humidityTrendDetail',
                    unit: '%',
                    threshold: 1.5,
                    format: (value) => `${value.toFixed(1)}%`
                },
                {
                    keys: ['co2'],
                    directionEl: 'co2TrendDirection',
                    detailEl: 'co2TrendDetail',
                    unit: 'ppm',
                    threshold: 40,
                    format: (value) => `${Math.round(value)} ppm`
                }
            ];

            const ensureElements = (config) => ({
                directionEl: document.getElementById(config.directionEl),
                detailEl: document.getElementById(config.detailEl)
            });

            if (!data || data.length < 2) {
                trendConfigs.forEach((config) => {
                    const { directionEl, detailEl } = ensureElements(config);
                    if (!directionEl || !detailEl) {
                        return;
                    }
                    directionEl.textContent = 'Nedostatek dat';
                    directionEl.className = 'trend-direction steady';
                    detailEl.textContent = 'Pro vykreslení trendu je potřeba více měření.';
                });
                return;
            }

            const firstPoint = data[0];
            const lastPoint = data[data.length - 1];

            const getValue = (point, keys) => {
                for (const key of keys) {
                    const value = point[key];
                    if (typeof value === 'number' && !Number.isNaN(value)) {
                        return value;
                    }
                }
                return null;
            };

            trendConfigs.forEach((config) => {
                const { directionEl, detailEl } = ensureElements(config);
                if (!directionEl || !detailEl) {
                    return;
                }

                const startValue = getValue(firstPoint, config.keys);
                const endValue = getValue(lastPoint, config.keys);

                if (startValue === null || endValue === null) {
                    directionEl.textContent = 'Čekám na data';
                    directionEl.className = 'trend-direction steady';
                    detailEl.textContent = 'Pro toto období chybí kompletní měření.';
                    return;
                }

                const change = endValue - startValue;
                const absChange = Math.abs(change);
                let directionLabel = 'Stabilní';
                let directionClass = 'steady';
                let detail = `Hodnota se drží kolem ${config.format(endValue)}.`;
                const thresholdText = Number.isInteger(config.threshold)
                    ? `${config.threshold}`
                    : config.threshold.toFixed(1);
                const arrowUp = '▲';
                const arrowDown = '▼';
                const arrowFlat = '⭮';

                if (absChange <= config.threshold) {
                    directionLabel = `${arrowFlat} Stabilní`;
                    detail = `Změna je menší než ${thresholdText} ${config.unit}; prostředí zůstává stabilní.`;
                } else if (change > 0) {
                    directionLabel = `${arrowUp} Rostoucí trend`;
                    directionClass = 'raising';
                    detail = `Nárůst o ${config.format(absChange)} od začátku (${config.format(startValue)} → ${config.format(endValue)}).`;
                } else {
                    directionLabel = `${arrowDown} Klesající trend`;
                    directionClass = 'falling';
                    detail = `Pokles o ${config.format(absChange)} od začátku (${config.format(startValue)} → ${config.format(endValue)}).`;
                }

                directionEl.textContent = directionLabel;
                directionEl.className = `trend-direction ${directionClass}`;
                detailEl.textContent = detail;
            });
        }

        function updateServerStatus(isOnline) {
            const statusDot = document.getElementById('serverStatus');
            const statusText = document.getElementById('serverStatusText');

            if (isOnline) {
                statusDot.className = 'status-dot online';
                statusText.textContent = 'Server online';
            } else {
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'Server offline';
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            if (errorContainer) {
                errorContainer.innerHTML = `<div class="alert">⚠️ ${message}</div>`;
                errorContainer.style.display = 'block';
            } else {
                console.error('Error container not found! Message:', message);
            }
        }

        function clearError() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        function refreshData() {
            fetchData();
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Dashboard: DOMContentLoaded event fired');
            try {
                pageEl = document.querySelector('.page');
                if (!pageEl) {
                    console.error('Dashboard: .page element not found!');
                }
                console.log('Dashboard: Initializing charts and fetching data...');
                initCharts();
                fetchData();

                autoRefreshInterval = setInterval(fetchData, 30000);
                const timeRangeEl = document.getElementById('timeRange');
                if (timeRangeEl) {
                    timeRangeEl.addEventListener('change', fetchData);
                } else {
                    console.error('Dashboard: timeRange element not found!');
                }
                console.log('Dashboard: Initialization complete');
            } catch (error) {
                console.error('Dashboard: Error during initialization:', error);
                showError(`Chyba při inicializaci dashboardu: ${error.message}`);
            }
        });
    </script>
</body>
</html>
