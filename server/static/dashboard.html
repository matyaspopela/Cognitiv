<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognitiv • Environmental Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
    <style>
        :root {
            --bg: #eef2ff;
            --surface: #ffffff;
            --surface-elevated: rgba(255, 255, 255, 0.9);
            --outline: rgba(15, 23, 42, 0.08);
            --shadow: 0 28px 48px rgba(15, 23, 42, 0.12);
            --shadow-soft: 0 18px 36px rgba(15, 23, 42, 0.08);
            --text: #0f172a;
            --muted: #64748b;
            --accent: #2563eb;
            --accent-strong: #9333ea;
            --success: #16a34a;
            --warning: #f97316;
            --danger: #dc2626;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(160deg, #eef2ff 0%, #f8fafc 50%, #e0f2fe 100%);
            color: var(--text);
            min-height: 100vh;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        .page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: clamp(20px, 4vw, 40px);
        }

        header {
            background: var(--surface);
            border-radius: clamp(20px, 3vw, 32px);
            padding: clamp(24px, 3vw, 36px);
            border: 1px solid var(--outline);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: clamp(18px, 2vw, 28px);
        }

        .header-top {
            display: flex;
            flex-wrap: wrap;
            gap: clamp(16px, 2vw, 28px);
            justify-content: space-between;
            align-items: flex-start;
        }

        .brand-group {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .top-links {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
        }

        .brand-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 13px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--muted);
            background: rgba(37, 99, 235, 0.12);
            padding: 8px 14px;
            border-radius: 999px;
        }

        .top-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            border-radius: 999px;
            font-weight: 500;
            font-size: 14px;
            color: var(--muted);
            background: rgba(148, 163, 184, 0.12);
            transition: background 0.25s ease, color 0.25s ease, transform 0.25s ease;
        }

        .top-link:hover,
        .top-link.active {
            background: rgba(37, 99, 235, 0.16);
            color: var(--accent);
            transform: translateY(-2px);
        }

        .header-nav {
            display: inline-flex;
            align-items: center;
            gap: 14px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        .header-nav a {
            padding: 8px 16px;
            border-radius: 999px;
            font-weight: 500;
            font-size: 14px;
            color: var(--muted);
            transition: background 0.25s ease, color 0.25s ease;
        }

        .header-nav a:hover,
        .header-nav a.active {
            background: rgba(37, 99, 235, 0.14);
            color: var(--accent);
        }

        h1 {
            margin: 0;
            font-size: clamp(28px, 4vw, 38px);
            letter-spacing: -0.01em;
        }

        .subtitle {
            margin: 0;
            color: var(--muted);
            font-size: 15px;
        }

        .status-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.16);
            font-size: 14px;
            font-weight: 500;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.online {
            background: var(--success);
        }

        .status-dot.offline {
            background: var(--danger);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .last-update {
            font-size: 13px;
            color: var(--muted);
        }

        .header-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
        }

        .controls-left {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }

        .control-label {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--muted);
        }

        select {
            padding: 12px 16px;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(248, 250, 252, 0.85);
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            min-width: 180px;
            outline: none;
            box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.05);
        }

        button {
            padding: 12px 20px;
            border-radius: 14px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
            color: #fff;
            box-shadow: 0 16px 32px rgba(37, 99, 235, 0.35);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .content {
            margin-top: clamp(28px, 4vw, 48px);
            display: flex;
            flex-direction: column;
            gap: clamp(28px, 4vw, 48px);
        }

        .alert {
            border-radius: 18px;
            padding: 14px 18px;
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
            border: 1px solid rgba(220, 38, 38, 0.2);
            font-weight: 500;
        }

        .metrics-grid {
            display: grid;
            gap: clamp(18px, 2.5vw, 24px);
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .metric-card {
            background: var(--surface);
            border-radius: 22px;
            padding: clamp(20px, 2.2vw, 26px);
            border: 1px solid var(--outline);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--muted);
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .metric-value {
            font-size: clamp(30px, 3.4vw, 36px);
            font-weight: 700;
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .metric-value.temp {
            color: #f97316;
        }

        .metric-value.humidity {
            color: #0ea5e9;
        }

        .metric-value.co2 {
            color: #14b8a6;
        }

        .metric-value.co2.warning {
            color: var(--warning);
        }

        .metric-value.co2.danger {
            color: var(--danger);
        }

        .metric-unit {
            font-size: 16px;
            font-weight: 500;
            color: var(--muted);
        }

        .metric-breakdown {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 13px;
            color: var(--muted);
        }

        .metric-breakdown span {
            display: inline-flex;
            gap: 6px;
            align-items: center;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.06);
            font-size: 12px;
            color: var(--muted);
        }

        .quality-card {
            background: var(--surface);
            border-radius: 24px;
            padding: clamp(24px, 3vw, 30px);
            border: 1px solid var(--outline);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .quality-header {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 12px;
        }

        .quality-header h2 {
            margin: 0;
            font-size: clamp(20px, 2.6vw, 26px);
        }

        .quality-header p {
            margin: 0;
            color: var(--muted);
            font-size: 14px;
        }

        .quality-bars {
            display: grid;
            gap: 14px;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        }

        .trend-analysis {
            background: var(--surface);
            border-radius: clamp(20px, 3vw, 28px);
            padding: clamp(24px, 3vw, 32px);
            border: 1px solid var(--outline);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: clamp(20px, 2vw, 28px);
        }

        .trend-analysis header {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .trend-analysis header h2 {
            margin: 0;
            font-size: clamp(20px, 3vw, 26px);
        }

        .trend-analysis header p {
            margin: 0;
            color: var(--muted);
            font-size: 14px;
        }

        .trend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: clamp(18px, 2.5vw, 24px);
        }

        .trend-card {
            border-radius: 20px;
            padding: clamp(18px, 2.4vw, 24px);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(147, 51, 234, 0.06));
            border: 1px solid rgba(148, 163, 184, 0.28);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.18);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .trend-card h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .trend-direction {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .trend-direction.raising {
            color: #16a34a;
        }

        .trend-direction.falling {
            color: #dc2626;
        }

        .trend-direction.steady {
            color: var(--muted);
        }

        .trend-detail {
            font-size: 13px;
            color: var(--muted);
            line-height: 1.5;
        }

        .quality-bar {
            border-radius: 18px;
            padding: 18px 20px;
            color: #fff;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quality-bar.good {
            background: linear-gradient(135deg, rgba(22, 163, 74, 0.85), rgba(34, 197, 94, 0.9));
        }

        .quality-bar.moderate {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.9), rgba(234, 179, 8, 0.9));
        }

        .quality-bar.poor {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.9), rgba(239, 68, 68, 0.85));
        }

        .quality-bar strong {
            font-size: 24px;
        }

        .quality-bar span {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .charts-section {
            background: var(--surface);
            border-radius: clamp(24px, 3vw, 36px);
            padding: clamp(24px, 3vw, 36px);
            border: 1px solid var(--outline);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: clamp(20px, 3vw, 28px);
        }

        .charts-header {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .charts-header h2 {
            margin: 0;
            font-size: clamp(22px, 3vw, 28px);
        }

        .charts-header p {
            margin: 0;
            color: var(--muted);
            font-size: 14px;
            max-width: 560px;
        }

        .chart-stack-wrapper {
            position: relative;
        }

        .chart-stack {
            display: flex;
            flex-direction: column;
            gap: clamp(28px, 3vw, 40px);
        }

        .chart-panel {
            background: var(--surface-elevated);
            border-radius: 24px;
            border: 1px solid var(--outline);
            padding: clamp(24px, 3vw, 32px);
            display: flex;
            flex-direction: column;
            gap: 18px;
            box-shadow: var(--shadow-soft);
            min-height: clamp(420px, 70vh, 560px);
        }

        .chart-panel h3 {
            margin: 0;
            font-size: clamp(18px, 2.6vw, 22px);
        }

        .chart-panel p {
            margin: 0;
            color: var(--muted);
            font-size: 14px;
        }

        .chart-canvas {
            position: relative;
            flex: 1;
            min-height: clamp(340px, 60vh, 520px);
        }

        .chart-canvas canvas {
            width: 100%;
            height: 100%;
        }

        footer {
            margin-top: clamp(40px, 5vw, 60px);
            text-align: center;
            color: var(--muted);
            font-size: 13px;
        }

        @media (max-width: 640px) {
            .header-controls {
                align-items: stretch;
            }

            select, button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <header>
            <div class="header-top">
                <div class="brand-group">
                    <div class="top-links">
                        <a class="brand-link" href="/">↖ Home</a>
                        <a class="top-link" href="/connect">Connect</a>
                        <a class="top-link active" href="/dashboard">Dashboard</a>
                    </div>
                    <div>
                        <h1>Environmental Intelligence Dashboard</h1>
                        <p class="subtitle">Deep dive into live comfort and air-quality signals from your Cognitiv sensors.</p>
                    </div>
                </div>
                <nav class="header-nav">
                    <a href="/">Home</a>
                    <a href="/connect">Connect</a>
                    <a href="/dashboard" class="active">Dashboard</a>
                </nav>
                <div class="status-group">
                    <div class="status-indicator">
                        <span class="status-dot online" id="serverStatus"></span>
                        <span id="serverStatusText">Server Online</span>
                    </div>
                    <div class="last-update" id="lastUpdate">Last update: Never</div>
                </div>
            </div>
            <div class="header-controls">
                <div class="controls-left">
                    <label class="control-label" for="timeRange">
                        Time horizon
                        <select id="timeRange">
                            <option value="1">Last 1 Hour</option>
                            <option value="6">Last 6 Hours</option>
                            <option value="24" selected>Last 24 Hours</option>
                            <option value="168">Last 7 Days</option>
                            <option value="720">Last 30 Days</option>
                        </select>
                    </label>
                </div>
                <button class="btn-primary" id="refreshButton" onclick="refreshData()">⟳ Refresh data</button>
            </div>
        </header>

        <main class="content">
            <div id="errorContainer"></div>

            <section class="metrics-grid">
                <article class="metric-card">
                    <div class="metric-header">
                        <span>Temperature</span>
                        <span class="badge">Comfort</span>
                    </div>
                    <div class="metric-value temp" id="currentTemp">
                        --<span class="metric-unit">°C</span>
                    </div>
                    <div class="metric-breakdown">
                        <span>Min <strong id="minTemp">--</strong></span>
                        <span>Max <strong id="maxTemp">--</strong></span>
                        <span>Avg <strong id="avgTemp">--</strong></span>
                    </div>
                </article>

                <article class="metric-card">
                    <div class="metric-header">
                        <span>Humidity</span>
                        <span class="badge">Moisture balance</span>
                    </div>
                    <div class="metric-value humidity" id="currentHumidity">
                        --<span class="metric-unit">%</span>
                    </div>
                    <div class="metric-breakdown">
                        <span>Min <strong id="minHumidity">--</strong></span>
                        <span>Max <strong id="maxHumidity">--</strong></span>
                        <span>Avg <strong id="avgHumidity">--</strong></span>
                    </div>
                </article>

                <article class="metric-card">
                    <div class="metric-header">
                        <span>CO₂ Level</span>
                        <span class="badge">Air quality</span>
                    </div>
                    <div class="metric-value co2" id="currentCO2">
                        --<span class="metric-unit">ppm</span>
                    </div>
                    <div class="metric-breakdown">
                        <span>Min <strong id="minCO2">--</strong></span>
                        <span>Max <strong id="maxCO2">--</strong></span>
                        <span>Avg <strong id="avgCO2">--</strong></span>
                    </div>
                </article>

                <article class="metric-card">
                    <div class="metric-header">
                        <span>Data coverage</span>
                        <span class="badge">Insights</span>
                    </div>
                    <div class="metric-value" style="color: var(--accent);" id="dataPoints">
                        --
                    </div>
                    <div class="metric-breakdown">
                        <span>Readings in window</span>
                    </div>
                </article>
            </section>

            <section class="quality-card">
                <div class="quality-header">
                    <h2>Air quality distribution</h2>
                    <p>Percentage of readings within each CO₂ comfort band for the selected period.</p>
                </div>
                <div class="quality-bars">
                    <div class="quality-bar good">
                        <span>Good</span>
                        <strong id="co2Good">--%</strong>
                        <small>&lt; 800 ppm</small>
                    </div>
                    <div class="quality-bar moderate">
                        <span>Moderate</span>
                        <strong id="co2Moderate">--%</strong>
                        <small>800 – 1000 ppm</small>
                    </div>
                    <div class="quality-bar poor">
                        <span>Poor</span>
                        <strong id="co2Poor">--%</strong>
                        <small>&gt; 1000 ppm</small>
                    </div>
                </div>
            </section>

            <section class="trend-analysis">
                <header>
                    <h2>Trend insights</h2>
                    <p>We compare the first and latest readings in the selected window to highlight whether conditions are rising, falling, or holding steady.</p>
                </header>
                <div class="trend-grid">
                    <article class="trend-card">
                        <h3>Temperature</h3>
                        <div class="trend-direction steady" id="tempTrendDirection">--</div>
                        <div class="trend-detail" id="tempTrendDetail">Waiting for data…</div>
                    </article>
                    <article class="trend-card">
                        <h3>Humidity</h3>
                        <div class="trend-direction steady" id="humidityTrendDirection">--</div>
                        <div class="trend-detail" id="humidityTrendDetail">Waiting for data…</div>
                    </article>
                    <article class="trend-card">
                        <h3>CO₂</h3>
                        <div class="trend-direction steady" id="co2TrendDirection">--</div>
                        <div class="trend-detail" id="co2TrendDetail">Waiting for data…</div>
                    </article>
                </div>
            </section>

            <section class="charts-section">
                <div class="charts-header">
                    <h2>Trend explorer</h2>
                    <p>Each chart expands across the page for comfortable review of temperature, humidity, and CO₂ signals.</p>
                </div>
                <div class="chart-stack-wrapper">
                    <div class="chart-stack" id="chartStack">
                        <article class="chart-panel" data-chart="temperature">
                            <div>
                                <h3>Temperature over time</h3>
                                <p>Track microclimate changes and quickly identify heating or cooling events.</p>
                            </div>
                            <div class="chart-canvas">
                                <canvas id="tempChart"></canvas>
                            </div>
                        </article>
                        <article class="chart-panel" data-chart="humidity">
                            <div>
                                <h3>Humidity over time</h3>
                                <p>Ensure ambient moisture stays in the healthy range for comfort and equipment.</p>
                            </div>
                            <div class="chart-canvas">
                                <canvas id="humidityChart"></canvas>
                            </div>
                        </article>
                        <article class="chart-panel" data-chart="co2">
                            <div>
                                <h3>CO₂ levels over time</h3>
                                <p>Spot ventilation gaps with threshold markers for moderate and poor air quality.</p>
                            </div>
                            <div class="chart-canvas">
                                <canvas id="co2Chart"></canvas>
                            </div>
                        </article>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            Designed for clarity and calm monitoring. <a href="/">Return home</a>
        </footer>
    </div>

    <script>
        let tempChart, humidityChart, co2Chart;
        let autoRefreshInterval;

        function initCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#e2e8f0',
                        padding: 12,
                        displayColors: false,
                        borderWidth: 1,
                        borderColor: 'rgba(148, 163, 184, 0.3)'
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(148, 163, 184, 0.15)'
                        },
                        ticks: {
                            color: 'rgba(100, 116, 139, 0.9)',
                            maxRotation: 0,
                            autoSkipPadding: 16
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(148, 163, 184, 0.15)'
                        },
                        ticks: {
                            color: 'rgba(100, 116, 139, 0.9)'
                        }
                    }
                }
            };

            const tempCtx = document.getElementById('tempChart').getContext('2d');
            tempChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: [],
                        borderColor: '#fb923c',
                        backgroundColor: 'rgba(251, 146, 60, 0.12)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.35
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            title: {
                                display: true,
                                text: '°C'
                            }
                        }
                    }
                }
            });

            const humidityCtx = document.getElementById('humidityChart').getContext('2d');
            humidityChart = new Chart(humidityCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Humidity (%)',
                        data: [],
                        borderColor: '#38bdf8',
                        backgroundColor: 'rgba(56, 189, 248, 0.12)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.35
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            title: {
                                display: true,
                                text: '%'
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    }
                }
            });

            const co2Ctx = document.getElementById('co2Chart').getContext('2d');
            co2Chart = new Chart(co2Ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CO₂ (ppm)',
                        data: [],
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.12)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.35
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            title: {
                                display: true,
                                text: 'ppm'
                            }
                        }
                    },
                    plugins: {
                        ...commonOptions.plugins,
                        annotation: {
                            annotations: {
                                moderate: {
                                    type: 'line',
                                    yMin: 800,
                                    yMax: 800,
                                    borderColor: '#f97316',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        enabled: true,
                                        content: 'Moderate (800 ppm)',
                                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                        color: '#fff',
                                        position: 'start'
                                    }
                                },
                                poor: {
                                    type: 'line',
                                    yMin: 1000,
                                    yMax: 1000,
                                    borderColor: '#dc2626',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        enabled: true,
                                        content: 'Poor (1000 ppm)',
                                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                        color: '#fff',
                                        position: 'start'
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        async function fetchData() {
            try {
                const hours = document.getElementById('timeRange').value;

                const dataResponse = await fetch(`/data?hours=${hours}`);
                const dataJson = await dataResponse.json();

                const statsResponse = await fetch(`/stats?hours=${hours}`);
                const statsJson = await statsResponse.json();

                if (dataJson.status === 'success' && statsJson.status === 'success') {
                    updateUI(dataJson.data, statsJson.stats);
                    updateServerStatus(true);
                    clearError();
                } else {
                    throw new Error('Failed to fetch data');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                updateServerStatus(false);
                showError('Failed to connect to server. Please check if the server is running.');
            }
        }

        function updateUI(data, stats) {
            if (!data || data.length === 0 || !stats || Object.keys(stats).length === 0) {
                showError('No data available. Waiting for sensor readings…');
                return;
            }

            document.getElementById('currentTemp').innerHTML =
                `${stats.temperature.current}<span class="metric-unit">°C</span>`;
            document.getElementById('currentHumidity').innerHTML =
                `${stats.humidity.current}<span class="metric-unit">%</span>`;

            const co2Element = document.getElementById('currentCO2');
            co2Element.innerHTML = `${stats.co2.current}<span class="metric-unit">ppm</span>`;
            co2Element.className = 'metric-value co2';
            if (stats.co2.current > 1000) {
                co2Element.classList.add('danger');
            } else if (stats.co2.current > 800) {
                co2Element.classList.add('warning');
            }

            document.getElementById('minTemp').textContent = stats.temperature.min;
            document.getElementById('maxTemp').textContent = stats.temperature.max;
            document.getElementById('avgTemp').textContent = stats.temperature.avg;

            document.getElementById('minHumidity').textContent = stats.humidity.min;
            document.getElementById('maxHumidity').textContent = stats.humidity.max;
            document.getElementById('avgHumidity').textContent = stats.humidity.avg;

            document.getElementById('minCO2').textContent = stats.co2.min;
            document.getElementById('maxCO2').textContent = stats.co2.max;
            document.getElementById('avgCO2').textContent = stats.co2.avg;

            document.getElementById('dataPoints').textContent = stats.data_points;

            const quality = stats.co2_quality || { good_percent: 0, moderate_percent: 0, poor_percent: 0 };
            document.getElementById('co2Good').textContent = `${quality.good_percent}%`;
            document.getElementById('co2Moderate').textContent = `${quality.moderate_percent}%`;
            document.getElementById('co2Poor').textContent = `${quality.poor_percent}%`;

            updateCharts(data);
            updateTrendInsights(data);

            const lastData = data[data.length - 1];
            document.getElementById('lastUpdate').textContent =
                `Last update: ${lastData.timestamp}`;
        }

        function updateCharts(data) {
            let sampledData = data;
            if (data.length > 200) {
                const step = Math.ceil(data.length / 200);
                sampledData = data.filter((_, index) => index % step === 0);
            }

            const labels = sampledData.map((point) => {
                const date = new Date(point.timestamp);
                return date.toLocaleString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            });

            tempChart.data.labels = labels;
            tempChart.data.datasets[0].data = sampledData.map((point) => point.temp_avg ?? point.temperature);
            tempChart.update();

            humidityChart.data.labels = labels;
            humidityChart.data.datasets[0].data = sampledData.map((point) => point.humidity_avg ?? point.humidity);
            humidityChart.update();

            co2Chart.data.labels = labels;
            co2Chart.data.datasets[0].data = sampledData.map((point) => point.co2);
            co2Chart.update();
        }

        function updateTrendInsights(data) {
            const trendConfigs = [
                {
                    keys: ['temp_avg', 'temperature'],
                    directionEl: 'tempTrendDirection',
                    detailEl: 'tempTrendDetail',
                    unit: '°C',
                    threshold: 0.4,
                    format: (value) => `${value.toFixed(1)}°C`
                },
                {
                    keys: ['humidity_avg', 'humidity'],
                    directionEl: 'humidityTrendDirection',
                    detailEl: 'humidityTrendDetail',
                    unit: '%',
                    threshold: 1.5,
                    format: (value) => `${value.toFixed(1)}%`
                },
                {
                    keys: ['co2'],
                    directionEl: 'co2TrendDirection',
                    detailEl: 'co2TrendDetail',
                    unit: 'ppm',
                    threshold: 40,
                    format: (value) => `${Math.round(value)} ppm`
                }
            ];

            const ensureElements = (config) => ({
                directionEl: document.getElementById(config.directionEl),
                detailEl: document.getElementById(config.detailEl)
            });

            if (!data || data.length < 2) {
                trendConfigs.forEach((config) => {
                    const { directionEl, detailEl } = ensureElements(config);
                    if (!directionEl || !detailEl) {
                        return;
                    }
                    directionEl.textContent = 'Not enough data';
                    directionEl.className = 'trend-direction steady';
                    detailEl.textContent = 'Collect more readings to establish a trend.';
                });
                return;
            }

            const firstPoint = data[0];
            const lastPoint = data[data.length - 1];

            const getValue = (point, keys) => {
                for (const key of keys) {
                    const value = point[key];
                    if (typeof value === 'number' && !Number.isNaN(value)) {
                        return value;
                    }
                }
                return null;
            };

            trendConfigs.forEach((config) => {
                const { directionEl, detailEl } = ensureElements(config);
                if (!directionEl || !detailEl) {
                    return;
                }

                const startValue = getValue(firstPoint, config.keys);
                const endValue = getValue(lastPoint, config.keys);

                if (startValue === null || endValue === null) {
                    directionEl.textContent = 'Awaiting data';
                    directionEl.className = 'trend-direction steady';
                    detailEl.textContent = 'Sensor readings are incomplete for this window.';
                    return;
                }

                const change = endValue - startValue;
                const absChange = Math.abs(change);
                let directionLabel = 'Stable';
                let directionClass = 'steady';
                let detail = `Holding near ${config.format(endValue)}.`;
                const thresholdText = Number.isInteger(config.threshold)
                    ? `${config.threshold}`
                    : config.threshold.toFixed(1);
                const arrowUp = '▲';
                const arrowDown = '▼';
                const arrowFlat = '⭮';

                if (absChange <= config.threshold) {
                    directionLabel = `${arrowFlat} Holding steady`;
                    detail = `Shift smaller than ${thresholdText} ${config.unit}; environment is consistent.`;
                } else if (change > 0) {
                    directionLabel = `${arrowUp} Trending upward`;
                    directionClass = 'raising';
                    detail = `Up ${config.format(absChange)} since the start (${config.format(startValue)} → ${config.format(endValue)}).`;
                } else {
                    directionLabel = `${arrowDown} Trending downward`;
                    directionClass = 'falling';
                    detail = `Down ${config.format(absChange)} since the start (${config.format(startValue)} → ${config.format(endValue)}).`;
                }

                directionEl.textContent = directionLabel;
                directionEl.className = `trend-direction ${directionClass}`;
                detailEl.textContent = detail;
            });
        }

        function updateServerStatus(isOnline) {
            const statusDot = document.getElementById('serverStatus');
            const statusText = document.getElementById('serverStatusText');

            if (isOnline) {
                statusDot.className = 'status-dot online';
                statusText.textContent = 'Server Online';
            } else {
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'Server Offline';
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="alert">⚠️ ${message}</div>`;
        }

        function clearError() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        function refreshData() {
            fetchData();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            fetchData();

            autoRefreshInterval = setInterval(fetchData, 30000);
            document.getElementById('timeRange').addEventListener('change', fetchData);
        });
    </script>
</body>
</html>
